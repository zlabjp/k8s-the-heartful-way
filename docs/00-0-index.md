# デモシナリオ案

- デモの前に、k8sの説明をする。(k8sの利用者視点で)。
- この時点ではアーキテクチャはわからない、とりあえずkubectlでServiceやらReplicaSetが使えて便利、という話をする。
    - k8s はイイモノだね！ってわかるように説明する。
    - 須田さんが、ヒトコトで誰もがk8sは良いものだねとわかるような説明する。
        - 宣言的なところとか。
        - 初心者向けなので、マニフェスト(申請書みたいなもの)とか、kubectl とかの説明も入れておいた方がよさそう。
        - k8s の申請書はyaml、人間でも読める形式で書きます。
        - デプロイの手順書ではなくて、仕様書を提出します。これはk8sではマニフェストと呼びます。
- では、裏側でどうなっているのかのデモをします、という流れ。
- 各セリフにスライドが欲しい。
- 各デモの後に真面目な説明をする。
- リモート参加は裏方でReplicaSetやPodを登録する
- アーキテクチャがわかるスライドがデモを進めると出来上がっていく感じ。
- デモの内容(出勤！みたいな。稲津くんが初めて出社した時には〜〜)、コマンドの内容が書いたスライド、真面目な説明をスライドで。デモの内容は不真面目な感じをできるだけだし、真面目な説明との対比をつける。

X社の登場人物紹介を入れる。

須田さん:

架空の会社の話をします。(仮にX社とします。)
その会社は、Kubernetesのアーキテクチャが難しすぎ、運用ができないと判断しました。
しかし、世の中はクラウドネイティブです。
Cなんちゃらcomputing foundation, 略してCNCF曰く、クラウドネイティブイコールKubernetesです。
世の中の流れ的に全てを拒否できないだろうと会社の上層部は判断し、
会社のクラウドネイティブの達人である私に聞きました。
「Kubernetesで一番重要なコンポーネントはなんだ？」
「apiserverです。」私は答えました。

こうして、apiserverのみが導入され、その他を全て手作業とする業務フローが生まれたのでした。

稲津さん:

そんな会社の運用部門に配属されたのが私だったりするのです。まあ、架空の話なのですけど。
私はその運用部門で「クベレット」という担当業務を行うことになったのです。

まず、私は一台のパソコンを割り当てられ、セットアップすることを命じられました。

## 初出社 (40minで収まらなかったら消しても良いシーン)

- スライドは三種類
    - ふわっとしたデモのシチュエーション説明。
    - カンペでも使えるようなコマンドの説明をした具体的な操作説明。
    - 真面目な説明。

稲津くんがワクワクして出社してきました。
稲津くんの初出社は何をするのでしょう？

コマンド一覧などをスライドで。

- ノードセットアップのデモ
    - network のインストール。
    - node の登録。
    - TODO: ipvs のインストール？
    - MEMO: Bob のマシンを事前にセットアップしておく必要がある。

真面目な説明: いましたことを真面目に説明すると、k8s では、ノード~~~

## 出勤

稲津くんの出勤！

稲津さん:

初出社を終え、次の日からは早速本格的な業務に取り掛かることになりました。
Kubernetesは自動化されたシステムなのでもちろん、出勤もシステムにつけることになります。

- 出勤のデモ
    - curl で status をポスト

須田さん:

そうすることで私の方でも稲津が出社したことを1コマンドで確認できるわけです。
今日は出社している人が多いですねー。

- 出勤確認のデモ
    - kubectl get node
    - TODO: X社のメンバー全員を登録しておく。

## 初仕事

### Pod を Node で実行する

須田さん:

さて、私にはいくつかの担当業務があるのですが、そのうちの一つが調整さんです。カタカナでスケジューラーという役割です。開発者が Kubernetes の Pod を apiserver に登録します。それを常に監視している役割です。
新しいPodが登録したら、そのPodをクベレット担当のどの人にそのPodの実行を任せるのかを決定するという大変重要な役割です。

稲津さんしか出社してないので稲津さんにスケジューリングします、みたいな。

- Pod を Node に割り当てるデモ

稲津さん:

さて、私は私で自分のノードにPodが割り当てられるのをずっと監視しております。
先ほど須田が私のノードにPodを割り当てたので、それを確認することができます。
では、私のノードでその、割り当てられたPodを起動しましょう。

XXX: 欲しい状態とずれた！っていうことをちゃんと監視してるような演劇をする。

- Node 上で Pod を起動するデモ

真面目な説明: プロセスが暴走したりするなどの欲しい状態とのずれなどを監視して、kubeletが戻してくれます、みたいなことをいう。

### ReplicaSet を登録する

須田さん:

通常、開発者はPod単体を直接扱うことをありません。ReplicaSetやDeploymentと言った上位のオブジェクトを利用してPodの世代管理やスケーリングを行なっています。
私はスケジューラの他にもコントローラマネージャという管理業務も行なっておりまして、この業務は何かと言うとReplicaSetやらDeploymentと言った上位のオブジェクトを監視して、それぞれをうまく担当に割り振る、みたいなことをしています。(XXX: 適当に説明しやすい感じでReplicaSetを説明するように台本変更しても可)

ここでは開発者がReplicaSetをリクエストして来た場合の話をします。

- ReplicaSet から Pod オブジェクトを登録するデモ

### Service を登録する

須田さん:

TODO: 適当に Service の説明をしてください！
コントローラマネージャはこのServiceを監視して、Endpoint と言うオブジェクトを作ることをしています、Endpointとは ~~~ (TODO: Endpoint の説明)

- Service から Endpoint を作成するデモ

稲津さん:

管理者は担当者の指示を全て Kubernetes のオブジェクト越しに行なって来ます。Endpoint を作成した、と言うことはノードを担当している実作業者が、そのEndpointにしたがって実際のロードバランサを設定する必要があります。本来はこの業務はクベプロキシーと言う担当者が行う業務なのですが、私はその業務を兼任していますので指示通りにノード内のロードバランサの設定をする必要があります。

- ServiceからIPVSを操作するデモ

今までは iptables を人でで操作するのは大変でしたが、ipvs になって管理がラクになりました。

真面目な説明: k8s の Service、今回のデモの場合は、クラスタ内のロードバランスを行うものを説明している。そのため、クラスタのノード内で設定している。クラスタ外のリクエストを受け付けるような設定もありますよ。

## デモまとめ

本来はkubernetesのコンポーネントが自動化して行なっていることを、全て人間が手作業で行うことができました！
各コンポーネントが何をやっているのかがわかりました。
